# Test Case: Java Registry Independence (Auto-Rewiring)
# Tests that Java Spring Boot agent continues serving even when registry is down.
#
# Scenario:
#   1. Start Java agent (registry auto-starts)
#   2. Agent registers and wires
#   3. Stop the registry process (but keep agent running)
#   4. Use curl to call agent directly - should still work
#
# This proves Java Spring Boot embedded Tomcat serves MCP independently of registry.
# Uses UC-level artifacts from /uc-artifacts

name: "Java Registry Independence"
description: "Verify Java Spring Boot agent works independently of registry after wiring"
tags:
  - registry
  - wiring
  - resilience
  - java
timeout: 300

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy artifact to workspace
  - name: "Copy artifact to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-greeter-agent /workspace/
      ls -la /workspace/java-greeter-agent/
    capture: copy_output

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-greeter-agent
    timeout: 600

  # Start agent (registry auto-starts)
  - name: "Start Java agent"
    handler: shell
    command: |
      meshctl start /workspace/java-greeter-agent -d
      echo "Java greeter agent starting via meshctl"
    capture: start_agent

  # Wait for registration (Java is slow to start)
  - name: "Wait for registration"
    handler: shell
    command: |
      echo "Waiting for java-greeter-agent..."
      for i in $(seq 1 45); do
        AGENTS=$(meshctl list 2>/dev/null || echo "")
        if echo "$AGENTS" | grep -q "java-greeter-agent"; then
          echo "Agent registered after $((i*2))s"
          exit 0
        fi
        if [ $((i % 10)) -eq 0 ]; then
          echo "Still waiting... ($((i*2))s)"
        fi
        sleep 2
      done
      echo "ERROR: Agent did not register within 90s"
      meshctl logs java-greeter-agent 2>/dev/null | tail -50 || true
      exit 1
    capture: wait_registration
    timeout: 120

  # Verify agent is registered
  - name: "Verify agent is registered"
    handler: shell
    command: "meshctl list"
    capture: list_before

  # Test meshctl call works (via registry)
  - name: "Test meshctl call via registry"
    handler: shell
    command: |
      echo "Attempting meshctl call..."
      timeout 10 meshctl call greet '{"name": "ViaRegistry"}' 2>&1 || echo "Call timed out or failed"
    timeout: 15
    capture: call_before

  # Stop the registry process (but keep agent running)
  - name: "Stop registry process"
    handler: shell
    command: |
      echo "Stopping registry..."
      meshctl stop registry
      echo "Registry stopped"
    capture: kill_registry

  # Short wait for registry to die
  - name: "Wait for registry to stop"
    handler: wait
    seconds: 2

  # Verify meshctl list fails (registry is down)
  - name: "Verify meshctl list fails without registry"
    handler: shell
    command: |
      if timeout 5 meshctl list 2>&1; then
        echo "UNEXPECTED: meshctl list worked without registry"
      else
        echo "EXPECTED: meshctl list failed (registry down)"
      fi
    timeout: 10
    capture: list_after_kill

  # === KEY TEST: Direct curl call should still work ===
  # Java Spring Boot basic-tool-agent runs on port 9001 by default
  - name: "Test direct curl call without registry"
    handler: shell
    command: |
      # Call the agent directly via curl (bypassing registry)
      RESPONSE=$(curl -s --max-time 10 -X POST http://localhost:9001/mcp \
        -H "Content-Type: application/json" \
        -H "Accept: application/json, text/event-stream" \
        -d '{
          "jsonrpc": "2.0",
          "id": 1,
          "method": "tools/call",
          "params": {
            "name": "greet",
            "arguments": {"name": "DirectCall"}
          }
        }' 2>&1)

      echo "Curl response: $RESPONSE"

      if echo "$RESPONSE" | grep -q "DirectCall"; then
        echo "PASS: Agent responded to direct curl call without registry"
      elif echo "$RESPONSE" | grep -q "Hello"; then
        echo "PASS: Agent responded to direct curl call without registry"
      else
        echo "FAIL: Agent did not respond correctly"
        exit 1
      fi
    capture: curl_call

  # Also test tools/list via curl
  - name: "Test tools/list via curl without registry"
    handler: shell
    command: |
      RESPONSE=$(curl -s --max-time 10 -X POST http://localhost:9001/mcp \
        -H "Content-Type: application/json" \
        -H "Accept: application/json, text/event-stream" \
        -d '{
          "jsonrpc": "2.0",
          "id": 1,
          "method": "tools/list",
          "params": {}
        }' 2>&1)

      echo "Tools list response: $RESPONSE"

      if echo "$RESPONSE" | grep -q "greet"; then
        echo "PASS: Agent tools/list works without registry"
      else
        echo "FAIL: Agent tools/list failed"
        exit 1
      fi
    capture: curl_list

assertions:
  # Agent was registered before killing registry
  - expr: "${captured.list_before} contains 'java-greeter-agent'"
    message: "Agent should be registered before stopping registry"

  # meshctl call worked before (via registry)
  - expr: "${captured.call_before} contains 'Hello'"
    message: "meshctl call should work when registry is up"

  # Direct curl call works without registry
  - expr: "${captured.curl_call} contains 'PASS'"
    message: "Direct curl call should work without registry"

  # tools/list via curl works without registry
  - expr: "${captured.curl_list} contains 'PASS'"
    message: "Direct tools/list should work without registry"

post_run:
  - handler: shell
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*greeter" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
