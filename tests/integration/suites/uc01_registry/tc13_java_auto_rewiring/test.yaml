# Test Case: Java Auto Rewiring / Registry Independence
# Tests that a wired Java agent continues serving even when registry is down.
#
# Ported from tc05_auto_rewiring (Python) to Java.
# This is complementary to tc07_java_registry_independence but follows the
# tc05 test structure more closely, including verifying meshctl call before
# stopping registry and testing direct curl after.
#
# Scenario:
#   1. Start Java agent (registry auto-starts)
#   2. Agent registers and wires
#   3. Test meshctl call works (via registry)
#   4. Capture agent port from meshctl list --wide
#   5. Stop the registry process (but keep agent running)
#   6. Verify meshctl list fails (registry is down)
#   7. Use curl to call agent directly - should still work
#
# Uses UC-level artifacts from /uc-artifacts:
#   - java-greeter-agent: Java Spring Boot agent with @MeshTool "greet"

name: "Java Auto Rewiring"
description: "Verify Java agent works independently of registry after wiring"
tags:
  - registry
  - wiring
  - resilience
  - java
timeout: 300

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy artifact to workspace
  - name: "Copy Java greeter agent to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-greeter-agent /workspace/
    capture: copy_output

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-greeter-agent
    timeout: 600

  # Start agent (registry auto-starts)
  - name: "Start Java agent with auto-starting registry"
    handler: shell
    command: |
      meshctl start /workspace/java-greeter-agent --env MCP_MESH_HTTP_PORT=9001 -d
      echo "Java greeter agent starting"
    capture: start_agent

  # Wait for registration (Java is slow to start)
  - name: "Wait for Java agent to register"
    handler: shell
    command: |
      echo "Waiting for greeter agent to register..."
      for i in $(seq 1 45); do
        AGENTS=$(meshctl list 2>/dev/null || echo "")
        if echo "$AGENTS" | grep -q "greeter"; then
          echo "Agent registered after $((i*2))s"
          exit 0
        fi
        if [ $((i % 10)) -eq 0 ]; then
          echo "Still waiting... ($((i*2))s)"
        fi
        sleep 2
      done
      echo "ERROR: Greeter agent did not register within 90s"
      meshctl logs greeter 2>/dev/null | tail -50 || true
      exit 1
    capture: wait_registration
    timeout: 120

  # Verify agent is registered
  - name: "Verify agent is registered"
    handler: shell
    command: "meshctl list"
    capture: list_before

  # Get agent port from --wide output for later direct curl
  - name: "Get agent port from meshctl list --wide"
    handler: shell
    command: |
      WIDE_OUTPUT=$(meshctl list --wide 2>/dev/null)
      echo "$WIDE_OUTPUT"
      # Extract port - agent is on 9001 as we set MCP_MESH_HTTP_PORT=9001
      echo "Agent port: 9001"
    capture: wide_output

  # Test meshctl call works (via registry)
  - name: "Test meshctl call via registry"
    handler: shell
    command: |
      echo "Attempting meshctl call..."
      timeout 10 meshctl call greet '{"name": "ViaRegistry"}' 2>&1 || echo "Call timed out or failed"
    timeout: 15
    capture: call_before

  # Stop the registry process (but keep agent running)
  - name: "Stop registry process"
    handler: shell
    command: |
      echo "Stopping registry..."
      meshctl stop registry
      echo "Registry stopped"
    capture: kill_registry

  # Short wait for registry to die
  - name: "Wait for registry to stop"
    handler: wait
    seconds: 2

  # Verify meshctl list fails (registry is down)
  - name: "Verify meshctl list fails without registry"
    handler: shell
    command: |
      if timeout 5 meshctl list 2>&1; then
        echo "UNEXPECTED: meshctl list worked without registry"
      else
        echo "EXPECTED: meshctl list failed (registry down)"
      fi
    timeout: 10
    capture: list_after_kill

  # === KEY TEST: Direct curl call should still work ===
  - name: "Test direct curl call without registry"
    handler: shell
    command: |
      # Call the agent directly via curl (bypassing registry)
      # Java greeter agent is on port 9001 (set via MCP_MESH_HTTP_PORT)
      RESPONSE=$(curl -s --max-time 10 -X POST http://localhost:9001/mcp \
        -H "Content-Type: application/json" \
        -H "Accept: application/json, text/event-stream" \
        -d '{
          "jsonrpc": "2.0",
          "id": 1,
          "method": "tools/call",
          "params": {
            "name": "greet",
            "arguments": {"name": "DirectCall"}
          }
        }' 2>&1)

      echo "Curl response: $RESPONSE"

      if echo "$RESPONSE" | grep -q "DirectCall"; then
        echo "PASS: Agent responded to direct curl call without registry"
      elif echo "$RESPONSE" | grep -q "Hello"; then
        echo "PASS: Agent responded to direct curl call without registry"
      else
        echo "FAIL: Agent did not respond correctly"
        exit 1
      fi
    capture: curl_call

  # Also test tools/list via curl
  - name: "Test tools/list via curl without registry"
    handler: shell
    command: |
      RESPONSE=$(curl -s --max-time 10 -X POST http://localhost:9001/mcp \
        -H "Content-Type: application/json" \
        -H "Accept: application/json, text/event-stream" \
        -d '{
          "jsonrpc": "2.0",
          "id": 1,
          "method": "tools/list",
          "params": {}
        }' 2>&1)

      echo "Tools list response: $RESPONSE"

      if echo "$RESPONSE" | grep -q "greet"; then
        echo "PASS: Agent tools/list works without registry"
      else
        echo "FAIL: Agent tools/list failed"
        exit 1
      fi
    capture: curl_list

assertions:
  # Agent was registered before killing registry
  - expr: "${captured.list_before} contains 'greeter'"
    message: "Agent should be registered before stopping registry"

  # meshctl call worked before (via registry)
  - expr: "${captured.call_before} contains 'Hello'"
    message: "meshctl call should work when registry is up"

  # Direct curl call works without registry
  - expr: "${captured.curl_call} contains 'PASS'"
    message: "Direct curl call should work without registry"

  # tools/list via curl works without registry
  - expr: "${captured.curl_list} contains 'PASS'"
    message: "Direct tools/list should work without registry"

post_run:
  - handler: shell
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*greeter" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
