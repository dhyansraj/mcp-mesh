# Test Case: Java LLM Provider Registration
# Tests that Java LLM provider agent registers correctly with mesh.
#
# Scenario:
#   - Start java-claude-provider agent
#   - Verify it registers with 'llm' capability
#   - Verify correct tags (llm, claude, anthropic, provider)

name: "Java LLM Provider Registration"
description: "Verify Java LLM provider registers llm capability with correct tags"
tags:
  - tools
  - meshctl
  - java
  - llm
  - provider
timeout: 300

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy artifact to workspace
  - name: "Copy LLM provider to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-claude-provider /workspace/
      cp /uc-artifacts/.env /workspace/java-claude-provider/
      ls -la /workspace/java-claude-provider/
    capture: copy_output

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-claude-provider
    timeout: 600

  # Start the provider with env file
  - name: "Start LLM provider agent"
    handler: shell
    command: |
      meshctl start /workspace/java-claude-provider --env-file /workspace/java-claude-provider/.env -d
      echo "LLM provider starting via meshctl"
    capture: start_agent

  # Wait for agent to register
  - name: "Wait for provider registration"
    handler: shell
    command: |
      echo "Waiting for claude-provider agent..."
      for i in $(seq 1 45); do
        AGENTS=$(meshctl list 2>/dev/null || echo "")
        if echo "$AGENTS" | grep -q "claude-provider"; then
          echo "Provider registered after $((i*2))s"
          exit 0
        fi
        if [ $((i % 10)) -eq 0 ]; then
          echo "Still waiting... ($((i*2))s)"
        fi
        sleep 2
      done
      echo "ERROR: Provider did not register within 90s"
      meshctl logs java-claude-provider 2>/dev/null | tail -50 || true
      exit 1
    capture: wait_registration
    timeout: 120

  # Verify agent is registered
  - name: "Verify provider registered"
    handler: shell
    command: "meshctl list"
    capture: list_output

  # Verify tools/capabilities
  - name: "List tools with details"
    handler: shell
    command: "meshctl list --tools"
    capture: list_tools

  # Get agent details (capabilities and tags)
  - name: "Get agent capabilities"
    handler: shell
    command: "meshctl list --json 2>/dev/null || meshctl list"
    capture: agent_details

assertions:
  # Provider registered
  - expr: "${captured.list_output} contains 'claude-provider'"
    message: "Claude provider agent should be registered"

  # LLM tool is available
  - expr: "${captured.list_tools} contains 'llm'"
    message: "llm tool should be listed"

  # Check for provider in output (indicates it's an LLM provider)
  - expr: "${captured.list_output} contains 'claude-provider'"
    message: "Agent should be named claude-provider"

post_run:
  - handler: shell
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*claude-provider" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
