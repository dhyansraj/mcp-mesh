# Test Case: Java Cross-Agent Tool Call
# Tests Java agent calling a TypeScript agent tool via mesh.
#
# Scenario:
#   - java-greeter-agent has addViaMesh tool (depends on capability="add")
#   - ts-calculator provides capability="add"
#   - Call addViaMesh which proxies to ts-calculator

name: "Java Cross-Agent Tool Call"
description: "Verify Java agent can call TypeScript agent tool via mesh dependency injection"
tags:
  - tools
  - meshctl
  - java
  - cross-agent
  - typescript
timeout: 300

pre_run:
  # Setup for Java agent
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
  # Setup for TypeScript agent
  - routine: global.setup_for_typescript_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy Java greeter artifact to workspace
  - name: "Copy Java greeter to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-greeter-agent /workspace/
      ls -la /workspace/java-greeter-agent/
    capture: copy_java

  # Copy TypeScript calculator artifact to workspace
  - name: "Copy TypeScript calculator to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/ts-calculator /workspace/
      ls -la /workspace/ts-calculator/
    capture: copy_ts

  # Install TypeScript dependencies
  - name: "Install TypeScript dependencies"
    handler: npm-install
    path: /workspace/ts-calculator
    timeout: 120

  # Install Maven dependencies for Java agent
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-greeter-agent
    timeout: 600

  # Start TypeScript calculator first (provides "add" capability)
  - name: "Start TypeScript calculator"
    handler: shell
    command: |
      meshctl start /workspace/ts-calculator/index.ts -d
      echo "TypeScript calculator starting via meshctl"
    capture: start_ts

  # Wait for TypeScript agent to register
  - name: "Wait for TypeScript calculator registration"
    handler: shell
    command: |
      echo "Waiting for TypeScript calculator..."
      for i in $(seq 1 20); do
        if meshctl list 2>/dev/null | grep -q "calculator"; then
          echo "Calculator registered after ${i}s"
          exit 0
        fi
        sleep 2
      done
      echo "ERROR: Calculator did not register within 40s"
      exit 1
    capture: wait_ts
    timeout: 60

  # Start Java greeter agent (depends on "add" capability)
  - name: "Start Java greeter agent"
    handler: shell
    command: |
      meshctl start /workspace/java-greeter-agent -d
      echo "Java greeter agent starting via meshctl"
    capture: start_java

  # Wait for Java agent to register
  - name: "Wait for Java greeter registration"
    handler: shell
    command: |
      echo "Waiting for Java greeter..."
      for i in $(seq 1 30); do
        if meshctl list 2>/dev/null | grep -q "greeter"; then
          echo "Greeter registered after ${i}s"
          exit 0
        fi
        sleep 2
      done
      echo "ERROR: Greeter did not register within 60s"
      meshctl logs greeter 2>/dev/null | tail -30 || true
      exit 1
    capture: wait_java
    timeout: 90

  # Verify both agents are registered
  - name: "Verify both agents registered"
    handler: shell
    command: "meshctl list"
    capture: list_agents

  # Verify tools are listed
  - name: "Verify tools are listed"
    handler: shell
    command: "meshctl list --tools"
    capture: list_tools

  # Call addViaMesh - this should call TypeScript calculator via mesh
  - name: "Call addViaMesh (Java -> TypeScript)"
    handler: shell
    command: 'meshctl call addViaMesh ''{"a": 5, "b": 3}'''
    capture: call_cross_agent

assertions:
  # Both agents registered
  - expr: "${captured.list_agents} contains 'calculator'"
    message: "TypeScript calculator should be registered"

  - expr: "${captured.list_agents} contains 'greeter'"
    message: "Java greeter should be registered"

  # Tools are listed
  - expr: "${captured.list_tools} contains 'add'"
    message: "add tool from calculator should be listed"

  - expr: "${captured.list_tools} contains 'addViaMesh'"
    message: "addViaMesh tool from greeter should be listed"

  # Cross-agent call succeeded - extract nested JSON and check result
  - expr: ${jq:captured.call_cross_agent:.content[0].text | fromjson | .result} == 8
    message: "Cross-agent call should return result=8"

  - expr: "${jq:captured.call_cross_agent:.content[0].text | fromjson | .callPath} contains 'greeter-java'"
    message: "Response should indicate Java source"

  - expr: "${jq:captured.call_cross_agent:.content[0].text | fromjson | .callPath} contains 'calculator-typescript'"
    message: "Response should show call path to TypeScript calculator"

post_run:
  # Stop all agents
  - handler: shell
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*greeter" 2>/dev/null || true
      pkill -f "tsx.*calculator" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
