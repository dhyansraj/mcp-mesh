# Test Case: Status Healthy Resolution (Java)
# Verifies meshctl status resolves to healthy agent when multiple match prefix
# Related Issue: https://github.com/dhyansraj/mcp-mesh/issues/460
#
# When multiple agents match a name prefix but only ONE is healthy,
# meshctl status should automatically resolve to the healthy agent
# instead of showing a disambiguation error.
#
# Note: Java agents register as {name}-{8char_uuid} (e.g., greeter-8918ca3c),
# so we use the short name "greeter" for status resolution.

name: "Status Healthy Resolution (Java)"
description: "Verify meshctl status resolves to healthy Java agent when only one matches"
tags:
  - meshctl
  - status
  - resolution
  - health
  - java
timeout: 300

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy Java greeter agent artifact
  - name: "Copy artifact to workspace"
    handler: shell
    command: "cp -r /uc-artifacts/java-greeter-agent /workspace/"
    capture: copy_output

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-greeter-agent
    timeout: 600

  # Start agent (first instance)
  - name: "Start agent (first instance)"
    # === First instance ===

    handler: shell
    workdir: /workspace
    command: "meshctl start /workspace/java-greeter-agent -d"
    capture: start_1

  # Wait for first instance to register
  - name: "Wait for first registration"
    handler: shell
    workdir: /workspace
    command: |
      for i in $(seq 1 30); do
        if meshctl list 2>/dev/null | grep -q "greeter"; then
          echo "Greeter registered (first instance)"
          exit 0
        fi
        sleep 2
      done
      echo "ERROR: First instance did not register within 60s"
      exit 1
    capture: wait_first
    timeout: 90

  # Verify first instance is registered
  - name: "List agents after first start"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_after_first

  # Stop first instance (becomes unhealthy in registry)
  - name: "Stop first instance"
    handler: shell
    command: |
      meshctl stop
      pkill -f "spring-boot:run" 2>/dev/null || true
    workdir: /workspace
    capture: stop_1

  # Wait for processes to terminate
  - name: "Wait after stop"
    handler: wait
    seconds: 5

  # Start agent again (second instance with different ID)
  - name: "Start agent (second instance)"
    # === Second instance ===

    handler: shell
    workdir: /workspace
    command: "meshctl start /workspace/java-greeter-agent -d"
    capture: start_2

  # Wait for second instance to register
  - name: "Wait for second registration"
    handler: shell
    workdir: /workspace
    command: |
      for i in $(seq 1 30); do
        if meshctl list 2>/dev/null | grep -q "greeter"; then
          echo "Greeter registered (second instance)"
          exit 0
        fi
        sleep 2
      done
      echo "ERROR: Second instance did not register within 60s"
      exit 1
    capture: wait_second
    timeout: 90

  # List all agents - should show multiple matching greeter
  - name: "List all agents"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_all

  # List with --healthy-only flag if available
  - name: "List healthy agents only"
    handler: shell
    command: "meshctl list --healthy-only 2>/dev/null || meshctl list"
    workdir: /workspace
    capture: list_healthy

  # This should resolve to the healthy agent, not error
  - name: "Status with prefix - should resolve to healthy"
    # === Key test: meshctl status with prefix ===
    # Use short name "greeter" since Java registers as greeter-{uuid}

    handler: shell
    command: "meshctl status greeter"
    workdir: /workspace
    capture: status_output

  # Cleanup
  - name: "Stop all agents"
    handler: shell
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
    workdir: /workspace

assertions:
  # First instance was registered
  - expr: "${captured.list_after_first} contains 'greeter'"
    message: "First agent instance should be registered"

  # Second instance is registered (list should show agent)
  - expr: "${captured.list_all} contains 'greeter'"
    message: "Agent should appear in meshctl list"

  # Status command should succeed (not error with "multiple agents match")
  - expr: ${steps.status_output.exit_code} == 0
    message: "meshctl status should succeed when only one healthy agent matches"

  # Status should NOT show disambiguation error
  - expr: "${captured.status_output} not contains 'multiple agents match'"
    message: "Should not show 'multiple agents match' error"

  # Status should NOT ask to specify more precise name
  - expr: "${captured.status_output} not contains 'specify a more precise'"
    message: "Should not ask to specify more precise name"

  # Status should show agent info (healthy status)
  - expr: "${captured.status_output} contains 'healthy'"
    message: "Status should show healthy agent info"

post_run:
  - handler: shell
    workdir: /workspace
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*greeter" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
