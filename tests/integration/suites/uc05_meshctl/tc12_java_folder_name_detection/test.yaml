# Test Case: Java Folder Name Auto Detection
# Verifies meshctl start accepts Java/Maven folder names with auto language detection
# meshctl must detect pom.xml and run mvn spring-boot:run
#
# Tests:
# 1. Start Java agent using folder name only (resolves pom.xml â†’ mvn spring-boot:run)
# 2. Start Java agent using absolute folder path

name: "Java Folder Name Auto Detection"
description: "Verify meshctl start detects pom.xml and launches Java agent correctly"
tags:
  - meshctl
  - start
  - folder-name
  - auto-detect
  - java
timeout: 300

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy artifact to workspace
  - name: "Copy artifact to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-greeter-agent /workspace/
      ls -la /workspace/java-greeter-agent/
    capture: copy_output

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-greeter-agent
    timeout: 600

  # === Test 1: Start using FOLDER NAME only ===
  # This is the key test - meshctl must detect pom.xml and run mvn spring-boot:run
  - name: "Start agent with folder name"
    handler: shell
    command: "meshctl start java-greeter-agent --env MCP_MESH_HTTP_PORT=0 -d"
    workdir: /workspace
    capture: start_output

  # Wait for registration (Java is slow to start)
  - name: "Wait for agent to register"
    handler: shell
    workdir: /workspace
    command: |
      echo "Waiting for greeter agent..."
      for i in $(seq 1 45); do
        AGENTS=$(meshctl list 2>/dev/null || echo "")
        if echo "$AGENTS" | grep -q "greeter"; then
          echo "Agent registered after $((i*2))s"
          exit 0
        fi
        if [ $((i % 10)) -eq 0 ]; then
          echo "Still waiting... ($((i*2))s)"
        fi
        sleep 2
      done
      echo "ERROR: Greeter agent did not register within 90s"
      meshctl logs greeter 2>/dev/null | tail -50 || true
      exit 1
    capture: wait_registration
    timeout: 120

  # Verify agent registered
  - name: "List agents after folder start"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: agent_list

  # Call the tool to verify it works
  - name: "Call greet tool"
    handler: shell
    command: |
      meshctl call greet '{"name": "FolderStart"}' 2>&1
    workdir: /workspace
    capture: greet_response

  # Stop all agents
  - name: "Stop all agents"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

  # Wait for cleanup
  - name: "Wait for cleanup"
    handler: wait
    seconds: 5

  # === Test 2: Start with ABSOLUTE FOLDER PATH ===
  - name: "Start agent with absolute folder path"
    handler: shell
    command: "meshctl start /workspace/java-greeter-agent --env MCP_MESH_HTTP_PORT=0 -d"
    workdir: /workspace
    capture: abs_start_output

  # Wait for registration
  - name: "Wait for agent to register (absolute path)"
    handler: shell
    workdir: /workspace
    command: |
      echo "Waiting for greeter agent (absolute path)..."
      for i in $(seq 1 45); do
        AGENTS=$(meshctl list 2>/dev/null || echo "")
        if echo "$AGENTS" | grep -q "greeter"; then
          echo "Agent registered after $((i*2))s"
          exit 0
        fi
        if [ $((i % 10)) -eq 0 ]; then
          echo "Still waiting... ($((i*2))s)"
        fi
        sleep 2
      done
      echo "ERROR: Greeter agent did not register within 90s"
      exit 1
    capture: wait_abs_registration
    timeout: 120

  # Verify agent registered with absolute path
  - name: "List agents after absolute path start"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: abs_agent_list

assertions:
  # Test 1: Folder name start
  - expr: ${steps.start_output.exit_code} == 0
    message: "meshctl start with Java folder name should succeed"

  - expr: "${captured.agent_list} contains 'greeter'"
    message: "Greeter agent should be registered (resolved from folder)"

  - expr: "${captured.greet_response} contains 'Hello'"
    message: "greet tool should respond with Hello"

  # Test 2: Absolute folder path start
  - expr: ${steps.abs_start_output.exit_code} == 0
    message: "meshctl start with absolute Java folder path should succeed"

  - expr: "${captured.abs_agent_list} contains 'greeter'"
    message: "Greeter agent should be registered (absolute folder path)"

post_run:
  - handler: shell
    workdir: /workspace
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*greeter" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
