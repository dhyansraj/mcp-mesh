# Test Case: TC39 - TS Consumer -> CLAUDE Provider (ts) -> JAVA Tool
# Tests cross-SDK tool calling: ts consumer invokes java tool via claude ts provider
#
# Scenario:
#   - Start weather-tool-java (port 9001)
#   - Start claude-provider-ts (port 9002)
#   - Start analyst-ts (port 9003)
#   - Test non-tool query and tool query

name: "Consumer TS -> Provider CLAUDE ts -> Tool JAVA"
description: "Test ts consumer with claude ts provider calling java tool"
tags:
  - toolcall
  - typescript
  - claude
  - typescript
  - phase2
  - java
timeout: 300

pre_run:
  - routine: global.setup_for_typescript_agent
  - routine: global.setup_for_java_agent

test:
  # 1. Copy artifacts to workspace
  - name: "Copy artifacts"
    handler: shell
    command: |
      cp -r /uc-artifacts/analyst-ts /workspace/
      cp -r /uc-artifacts/claude-provider-ts /workspace/
      cp -r /uc-artifacts/weather-tool-java /workspace/
      ls -la /workspace/
    capture: copy_output

  # 2. Create env file with secrets
  - name: "Create env file with secrets"
    handler: secrets
    target: /workspace/.env

  # 3. Install dependencies
  - name: "Install tool dependencies"
    handler: maven-install
    path: /workspace/weather-tool-java
    timeout: 600

  - name: "Install provider dependencies"
    handler: npm-install
    path: /workspace/claude-provider-ts

  - name: "Install consumer dependencies"
    handler: npm-install
    path: /workspace/analyst-ts

  # 3. Start tool agent (port 9001)
  - name: "Start tool agent"
    handler: shell
    command: |
      cd /workspace
      meshctl start weather-tool-java --env MCP_MESH_HTTP_PORT=9001 -d
      echo "Tool agent starting..."
    capture: start_tool

  - name: "Wait for tool agent"
    handler: wait
    seconds: 15

  # 4. Start provider agent (port 9002)
  - name: "Start provider agent"
    handler: shell
    command: |
      cd /workspace
      meshctl start claude-provider-ts/src/index.ts --env-file .env --env MCP_MESH_HTTP_PORT=9002 -d
      echo "Provider agent starting..."
    capture: start_provider

  - name: "Wait for provider agent"
    handler: wait
    seconds: 20

  # 5. Start consumer agent (port 9003)
  - name: "Start consumer agent"
    handler: shell
    command: |
      cd /workspace
      meshctl start analyst-ts/src/index.ts --env MCP_MESH_HTTP_PORT=9003 -d
      echo "Consumer agent starting..."
    capture: start_consumer

  - name: "Wait for consumer and resolution"
    handler: wait
    seconds: 25

  # 6. Verify all agents registered
  - name: "Verify agents registered"
    handler: shell
    command: |
      meshctl list
    capture: agent_list

  # 7. Non-tool query (capital of France)
  - name: "Non-tool query"
    handler: shell
    command: |
      meshctl call analyze '{"ctx": {"query": "What is the capital of France?"}}'
    capture: non_tool_response
    timeout: 120

  # 8. Tool query (weather in Boston)
  - name: "Tool query"
    handler: shell
    command: |
      meshctl call analyze '{"ctx": {"query": "What is the weather in Boston?"}}'
    capture: tool_response
    timeout: 120

assertions:
  - expr: "${captured.agent_list} contains 'analyst-ts'"
    message: "Consumer agent should be registered"
  - expr: "${captured.agent_list} contains 'claude-provider-ts'"
    message: "Provider agent should be registered"
  - expr: "${captured.agent_list} contains 'weather-tool-java'"
    message: "Tool agent should be registered"
  - expr: "${captured.non_tool_response} contains 'Paris'"
    message: "Non-tool response should mention Paris"
  - expr: "${captured.tool_response} contains 'Boston'"
    message: "Tool response should mention Boston"

post_run:
  - handler: shell
    command: |
      meshctl stop 2>/dev/null || true

    ignore_errors: true
  - routine: global.cleanup_workspace
