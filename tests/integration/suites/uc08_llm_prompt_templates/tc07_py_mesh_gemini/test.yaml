# Test Case: tc07_py_mesh_gemini
# Tests Python agent with context_param using Gemini provider mesh delegation
# Verifies context_param works with Python SDK and Gemini LLM

name: "Python Mesh Gemini Delegation"
description: "Test Python LLM agent with context_param using Gemini provider delegation"
tags:
  - llm
  - mesh-delegation
  - prompt-template
  - context-param
  - python
  - gemini
timeout: 120

pre_run:
  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy artifacts to workspace
  - name: "Copy artifacts to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/. /workspace/
    capture: copy_output

  # Verify workspace files
  - name: "Verify workspace files"
    handler: shell
    command: "ls -la /workspace/"
    capture: ls_output

  # Start the Gemini provider first (mesh delegation target)
  - name: "Start gemini-provider"
    handler: shell
    command: "meshctl start gemini-provider/main.py --env-file .env --env MCP_MESH_HTTP_PORT=9013 -d"
    workdir: /workspace
    capture: provider_start_output

  # Wait for provider to register
  - name: "Wait for provider to register"
    handler: wait
    seconds: 10

  # Verify provider is running
  - name: "Verify provider is running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: provider_list

  # Start the test agent (depends on provider for mesh delegation)
  - name: "Start context-self-dep-mesh-test agent"
    handler: shell
    command: "meshctl start prompt-template-examples/test_008_context_self_dep_mesh.py -d"
    workdir: /workspace
    capture: agent_start_output

  # Wait for agent to register and resolve dependencies
  - name: "Wait for agent to register"
    handler: wait
    seconds: 10

  # Verify both agents are running
  - name: "Verify agents are running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: agent_list

  # List available tools
  - name: "List available tools"
    handler: shell
    command: "meshctl list -t"
    workdir: /workspace
    capture: tools_output

  # Call the self-dependency context test tool (mesh delegation path)
  - name: "Call test_context_self_dep_mesh"
    handler: shell
    command: "meshctl call test_context_self_dep_mesh '{}'"
    workdir: /workspace
    capture: test_result

assertions:
  # Provider registered successfully
  - expr: ${captured.provider_list} contains 'gemini-provider'
    message: "gemini-provider should appear in meshctl list"

  # Test agent registered successfully
  - expr: ${captured.agent_list} contains 'context-self-dep-mesh-test'
    message: "context-self-dep-mesh-test agent should appear in meshctl list"

  # Tools are registered
  - expr: ${captured.tools_output} contains 'test_context_self_dep_mesh'
    message: "test_context_self_dep_mesh tool should be listed"

  - expr: ${captured.tools_output} contains 'extract_memories_mesh'
    message: "extract_memories_mesh tool should be listed"

  - expr: ${captured.tools_output} contains 'gemini_provider'
    message: "gemini_provider tool should be listed from provider"

  # Test passed - context was passed through to template via mesh delegation
  - expr: ${captured.test_result} contains 'test_passed'
    message: "Test result should contain test_passed field"

  - expr: ${captured.test_result} contains 'PASS'
    message: "Test should pass - context_param should work with Gemini provider"

post_run:
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
