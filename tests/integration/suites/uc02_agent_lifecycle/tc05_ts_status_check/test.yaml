# Test Case: TypeScript Agent Status Check
# Verifies that meshctl status command works correctly with a TypeScript agent

name: "TypeScript Agent Status Check"
description: "Test meshctl status command for running TypeScript agents"
tags:
  - lifecycle
  - typescript
  - status
timeout: 300

pre_run:
  # Setup for TypeScript agent (node + meshctl)
  - routine: global.setup_for_typescript_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Scaffold a test agent
  - name: "Scaffold test agent"
    handler: shell
    command: "meshctl scaffold --name status-agent-ts --agent-type tool --lang typescript"
    workdir: /workspace

  # Install npm dependencies
  - name: "Install npm dependencies"
    handler: npm-install
    path: /workspace/status-agent-ts

  # Check meshctl list (should show no running agents initially)
  - name: "Check meshctl list initially"
    handler: shell
    command: "meshctl list 2>&1 || true"
    workdir: /workspace
    capture: initial_list

  # Start agent with meshctl (detached mode, custom port)
  - name: "Start agent in detached mode"
    handler: shell
    command: "meshctl start status-agent-ts/src/index.ts --env MCP_MESH_HTTP_PORT=3005 -d"
    workdir: /workspace
    capture: start_output

  # Wait for startup
  - name: "Wait for startup"
    handler: wait
    seconds: 5

  # Check meshctl list (should show running agent)
  - name: "Check meshctl list shows running agent"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: running_list

  # Check meshctl status for detailed info
  - name: "Check meshctl status for detailed info"
    handler: shell
    command: "meshctl status 2>&1 || true"
    workdir: /workspace
    capture: status_output

  # Get agent logs
  - name: "Get agent logs"
    handler: shell
    command: "meshctl logs status-agent-ts 2>/dev/null | tail -20 || echo 'no logs'"
    workdir: /workspace
    capture: agent_logs

  # Stop agent
  - name: "Stop agent"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Agent was scaffolded
  - expr: ${file:/workspace/status-agent-ts/src/index.ts} exists
    message: "Agent should be scaffolded"

  # meshctl start succeeded
  - expr: ${captured.start_output} contains 'status-agent-ts'
    message: "meshctl start should report agent started"

  # Agent appears in meshctl list
  - expr: ${captured.running_list} contains 'status-agent-ts'
    message: "Agent should appear in meshctl list"

post_run:
  # Stop any remaining agents
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
