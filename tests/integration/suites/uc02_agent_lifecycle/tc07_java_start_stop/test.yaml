# Test Case: Java Agent Start/Stop
# Verifies that a Java agent can be started and stopped properly

name: "Java Agent Start and Stop"
description: "Test starting and gracefully stopping a Java agent"
tags:
  - lifecycle
  - java
  - smoke
timeout: 300

pre_run:
  # Setup for Java agent (Maven + meshctl)
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Scaffold a test agent
  - name: "Scaffold test agent"
    handler: shell
    command: "meshctl scaffold --name lifecycle-agent-java --agent-type tool --lang java"
    workdir: /workspace
    capture: scaffold_output

  # Verify scaffolded files exist
  - name: "Verify scaffolded pom.xml exists"
    handler: file
    path: /workspace/lifecycle-agent-java/pom.xml
    operation: exists

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/lifecycle-agent-java
    timeout: 600

  # Start agent with meshctl (detached mode, custom port)
  - name: "Start agent in detached mode"
    handler: shell
    command: "meshctl start lifecycle-agent-java --env MCP_MESH_HTTP_PORT=3007 -d"
    workdir: /workspace
    capture: start_output

  # Wait for Java agent registration (Java is slow to start)
  - name: "Wait for agent registration"
    handler: shell
    workdir: /workspace
    command: |
      echo "Waiting for Java agent to start..."
      for i in $(seq 1 45); do
        if meshctl list 2>/dev/null | grep -q "lifecycle-agent-java"; then
          echo "Agent registered after ${i} iterations"
          exit 0
        fi
        sleep 2
      done
      echo "ERROR: Agent did not register within 90s"
      meshctl logs lifecycle-agent-java 2>/dev/null | tail -50 || true
      exit 1
    capture: wait_registration
    timeout: 120

  # Check if agent is running with meshctl list
  - name: "Check agent is running with meshctl list"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # Show agent logs for debugging
  - name: "Show agent logs for debugging"
    handler: shell
    command: "meshctl logs lifecycle-agent-java 2>/dev/null | tail -20 || echo 'no logs'"
    workdir: /workspace
    capture: agent_logs

  # Stop agents with meshctl stop
  - name: "Stop agents with meshctl stop"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace
    capture: stop_output

  # Wait for process to terminate
  - name: "Wait for process to terminate"
    handler: wait
    seconds: 2

  # Verify agent is stopped
  - name: "Verify agent is stopped"
    handler: shell
    command: "meshctl list 2>&1 || echo 'no agents'"
    workdir: /workspace
    capture: stop_check

assertions:
  # Agent was scaffolded
  - expr: ${file:/workspace/lifecycle-agent-java/pom.xml} exists
    message: "Agent should be scaffolded with pom.xml"

  # meshctl start succeeded
  - expr: ${captured.start_output} contains 'lifecycle-agent-java'
    message: "meshctl start should report agent started"

  # Agent appears in meshctl list
  - expr: ${captured.list_output} contains 'lifecycle-agent-java'
    message: "Agent should appear in meshctl list"

post_run:
  # Stop any remaining agents (including Java-specific cleanup)
  - handler: shell
    workdir: /workspace
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*lifecycle-agent-java" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
