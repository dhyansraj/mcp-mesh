# Test Case: TypeScript Agent HTTP Endpoint
# Verifies that a TypeScript agent's HTTP endpoints work correctly

name: "TypeScript Agent HTTP Endpoint"
description: "Test TypeScript agent HTTP endpoints respond correctly"
tags:
  - lifecycle
  - typescript
  - http
  - api
timeout: 300

pre_run:
  # Setup for TypeScript agent (node + meshctl)
  - routine: global.setup_for_typescript_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Scaffold a test agent
  - name: "Scaffold test agent"
    handler: shell
    command: "meshctl scaffold --name http-agent-ts --agent-type tool --lang typescript"
    workdir: /workspace

  # Install npm dependencies
  - name: "Install npm dependencies"
    handler: npm-install
    path: /workspace/http-agent-ts

  # Start agent with meshctl (detached mode, custom port)
  - name: "Start agent in detached mode"
    handler: shell
    command: "meshctl start http-agent-ts/src/index.ts --env MCP_MESH_HTTP_PORT=3006 -d"
    workdir: /workspace
    capture: start_output

  # Wait for agent to start
  - name: "Wait for agent to start"
    handler: wait
    seconds: 5

  # Check if agent is running
  - name: "Check if agent is running"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # Test MCP endpoint with tools/list request
  - name: "Test MCP endpoint with tools/list request"
    handler: shell
    command: |
      curl -s -X POST http://localhost:3006/mcp \
        -H 'Content-Type: application/json' \
        -H 'Accept: application/json, text/event-stream' \
        -d '{"jsonrpc":"2.0","method":"tools/list","id":1,"params":{}}' \
        || echo 'CURL_FAILED'
    capture: tools_response

  # Get agent logs for debugging
  - name: "Get agent logs for debugging"
    handler: shell
    command: "meshctl logs http-agent-ts 2>/dev/null | tail -30 || echo 'no logs'"
    workdir: /workspace
    capture: agent_logs

  # Stop agent
  - name: "Stop agent"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Agent appears in meshctl list
  - expr: ${captured.list_output} contains 'http-agent-ts'
    message: "Agent should appear in meshctl list"

  # Tools list returns valid JSON-RPC response
  - expr: ${captured.tools_response} contains 'jsonrpc'
    message: "Tools endpoint should return JSON-RPC response"

  # Check for tools in response
  - expr: ${captured.tools_response} contains 'tools'
    message: "Response should contain tools list"

post_run:
  # Stop any remaining agents
  - handler: shell
    command: "meshctl stop 2>/dev/null || true"
    workdir: /workspace
    ignore_errors: true
  - routine: global.cleanup_workspace
