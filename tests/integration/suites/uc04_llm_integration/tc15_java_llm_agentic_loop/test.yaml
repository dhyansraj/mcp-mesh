# Test Case: Java LLM Agentic Loop
# Tests Java agent's agentic loop with tool use.
#
# Scenario:
#   - Start java-claude-provider (provides 'llm' capability)
#   - Start java-employee-service (provides employee data tools)
#   - Start java-analyst-agent (can use tools in agentic loop)
#   - Call analyst's analyze tool asking about employees
#   - Verify it uses tools and returns structured analysis

name: "UC04: Java LLM Agentic Loop"
description: "Verify Java analyst agent can use tools in agentic loop"
tags:
  - tools
  - meshctl
  - java
  - llm
  - agentic
  - loop
timeout: 600

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy all artifacts
  - name: "Copy provider to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-claude-provider /workspace/
    capture: copy_provider

  # Create env file for provider
  - name: "Create env file for provider"
    handler: secrets
    target: /workspace/java-claude-provider/.env

  - name: "Copy employee service to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-employee-service /workspace/
    capture: copy_employee

  - name: "Copy analyst to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-analyst-agent /workspace/
    capture: copy_analyst

  # Create env file for analyst
  - name: "Create env file for analyst"
    handler: secrets
    target: /workspace/java-analyst-agent/.env

  # Install dependencies
  - name: "Install provider dependencies"
    handler: maven-install
    path: /workspace/java-claude-provider
    timeout: 600

  - name: "Install employee service dependencies"
    handler: maven-install
    path: /workspace/java-employee-service
    timeout: 600

  - name: "Install analyst dependencies"
    handler: maven-install
    path: /workspace/java-analyst-agent
    timeout: 600

  # Start all agents
  - name: "Start LLM provider"
    handler: shell
    workdir: /workspace
    command: |
      meshctl start /workspace/java-claude-provider --env-file /workspace/java-claude-provider/.env -d
    capture: start_provider

  - name: "Wait for provider"
    handler: shell
    workdir: /workspace
    command: |
      for i in $(seq 1 45); do
        if meshctl list 2>/dev/null | grep -q "claude-provider"; then
          echo "Provider registered"
          exit 0
        fi
        sleep 2
      done
      exit 1
    capture: wait_provider
    timeout: 120

  - name: "Start employee service"
    handler: shell
    workdir: /workspace
    command: |
      meshctl start /workspace/java-employee-service -d
    capture: start_employee

  - name: "Wait for employee service"
    handler: shell
    workdir: /workspace
    command: |
      for i in $(seq 1 45); do
        if meshctl list 2>/dev/null | grep -q "employee-service"; then
          echo "Employee service registered"
          exit 0
        fi
        sleep 2
      done
      exit 1
    capture: wait_employee
    timeout: 120

  - name: "Start analyst agent"
    handler: shell
    workdir: /workspace
    command: |
      meshctl start /workspace/java-analyst-agent --env-file /workspace/java-analyst-agent/.env -d
    capture: start_analyst

  - name: "Wait for analyst"
    handler: shell
    workdir: /workspace
    command: |
      for i in $(seq 1 45); do
        if meshctl list 2>/dev/null | grep -q "analyst"; then
          echo "Analyst registered"
          exit 0
        fi
        sleep 2
      done
      exit 1
    capture: wait_analyst
    timeout: 120

  # Wait for all dependencies to resolve
  - name: "Wait for dependency resolution"
    handler: wait
    seconds: 8

  # Verify all agents running
  - name: "Verify all agents"
    handler: shell
    workdir: /workspace
    command: "meshctl list"
    capture: list_all

  # List all tools
  - name: "List all tools"
    handler: shell
    workdir: /workspace
    command: "meshctl list --tools"
    capture: list_tools

  # Call analyze with a query about employees
  - name: "Call analyze (agentic loop)"
    handler: shell
    workdir: /workspace
    command: 'meshctl call analyze ''{"query": "How many employees are in the Engineering department?"}'''
    capture: call_analyze
    timeout: 120

assertions:
  # All agents registered
  - expr: "${captured.list_all} contains 'claude-provider'"
    message: "Claude provider should be registered"

  - expr: "${captured.list_all} contains 'employee-service'"
    message: "Employee service should be registered"

  - expr: "${captured.list_all} contains 'analyst'"
    message: "Analyst should be registered"

  # Employee tools available
  - expr: "${captured.list_tools} contains 'getEmployee'"
    message: "getEmployee tool should be available"

  - expr: "${captured.list_tools} contains 'listEmployees'"
    message: "listEmployees tool should be available"

  # Analyze tool available
  - expr: "${captured.list_tools} contains 'analyze'"
    message: "analyze tool should be available"

  # Analyze returned a response (should mention Engineering or employees)
  - expr: "${jq:captured.call_analyze:.content[0].text | fromjson | .summary} != ''"
    message: "Analysis should return a non-empty summary"

post_run:
  - handler: shell
    workdir: /workspace
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*claude-provider" 2>/dev/null || true
      pkill -f "java.*employee" 2>/dev/null || true
      pkill -f "java.*analyst" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
