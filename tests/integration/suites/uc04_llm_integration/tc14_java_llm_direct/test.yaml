# Test Case: Java LLM Direct Agent
# Tests Java agent with direct LLM calls via Spring AI.
#
# Scenario:
#   - Start java-chatbot-agent (uses @MeshLlm with provider="claude")
#   - Call chat tool with a simple prompt
#   - Verify LLM responds correctly

name: "UC04: Java LLM Direct Agent"
description: "Verify Java agent can make direct LLM calls via Spring AI"
tags:
  - tools
  - meshctl
  - java
  - llm
  - direct
timeout: 360

pre_run:
  - routine: global.setup_for_java_agent
    params:
      meshctl_version: "${config.packages.cli_version}"

test:
  # Copy artifact to workspace
  - name: "Copy chatbot agent to workspace"
    handler: shell
    command: |
      cp -r /uc-artifacts/java-chatbot-agent /workspace/
      ls -la /workspace/java-chatbot-agent/
    capture: copy_output

  # Create env file with secrets
  - name: "Create env file with secrets"
    handler: secrets
    target: /workspace/java-chatbot-agent/.env

  # Install Maven dependencies
  - name: "Install Maven dependencies"
    handler: maven-install
    path: /workspace/java-chatbot-agent
    timeout: 600

  # Start the chatbot agent with env file
  - name: "Start chatbot agent"
    handler: shell
    command: |
      meshctl start /workspace/java-chatbot-agent --env-file /workspace/java-chatbot-agent/.env -d
      echo "Chatbot agent starting via meshctl"
    capture: start_agent

  # Wait for agent to register
  - name: "Wait for chatbot registration"
    handler: shell
    command: |
      echo "Waiting for chatbot agent..."
      for i in $(seq 1 45); do
        AGENTS=$(meshctl list 2>/dev/null || echo "")
        if echo "$AGENTS" | grep -q "chatbot"; then
          echo "Chatbot registered after $((i*2))s"
          exit 0
        fi
        if [ $((i % 10)) -eq 0 ]; then
          echo "Still waiting... ($((i*2))s)"
        fi
        sleep 2
      done
      echo "ERROR: Chatbot did not register within 90s"
      meshctl logs java-chatbot-agent 2>/dev/null | tail -50 || true
      exit 1
    capture: wait_registration
    timeout: 120

  # Verify agent is registered
  - name: "Verify chatbot registered"
    handler: shell
    command: "meshctl list"
    capture: list_output

  # Verify tools are listed
  - name: "Verify tools are listed"
    handler: shell
    command: "meshctl list --tools"
    capture: list_tools

  # Call chat tool with simple prompt
  - name: "Call chat tool"
    handler: shell
    command: 'meshctl call chat ''{"message": "What is 2+2? Reply with just the number."}'''
    capture: call_chat
    timeout: 60

  # Call explainCode tool
  - name: "Call explainCode tool"
    handler: shell
    command: 'meshctl call explainCode ''{"code": "print(\"hello\")", "language": "python"}'''
    capture: call_explain
    timeout: 60

assertions:
  # Agent registered
  - expr: "${captured.list_output} contains 'chatbot'"
    message: "Chatbot agent should be registered"

  # Tools are listed
  - expr: "${captured.list_tools} contains 'chat'"
    message: "chat tool should be listed"

  - expr: "${captured.list_tools} contains 'explainCode'"
    message: "explainCode tool should be listed"

  # Chat call returned a response (should contain "4" for 2+2)
  - expr: "${jq:captured.call_chat:.content[0].text | fromjson | .response} contains '4'"
    message: "Chat response should contain the answer 4"

  # Explain code returned a response
  - expr: "${jq:captured.call_explain:.content[0].text | fromjson | .explanation} contains 'print'"
    message: "Code explanation should reference the print function"

post_run:
  - handler: shell
    command: |
      meshctl stop 2>/dev/null || true
      pkill -f "spring-boot:run" 2>/dev/null || true
      pkill -f "java.*chatbot" 2>/dev/null || true
    ignore_errors: true
  - routine: global.cleanup_workspace
