# Test Case: MeshRoute / @mesh.route Handler Span Export
# Exposes bug #582: Route handler spans are NOT exported to Tempo.
# When an API route calls a mesh tool, only the tool call span appears in the
# trace -- the route handler span from the API agent is missing.
#
# Agent Setup:
#   - py-math-agent (port 9000): Tool agent providing "add" capability
#   - py-mesh-api (port 8080): API agent with @mesh.route depending on "add"
#
# Flow: curl with traceparent -> py-mesh-api /api/add -> py-math-agent add tool
#
# Expected (bug #582 fixed): Trace contains spans from BOTH agents
# Actual   (bug #582 open):  Trace contains span from py-math-agent only

name: "MeshRoute handler spans exported to Tempo"
description: >
  Verify that @mesh.route decorator (Python) exports trace spans to Tempo.
  When an API route handler calls a mesh tool, the trace should contain spans
  from both the route handler agent and the tool provider agent.
  Bug #582: route handler span is missing from the trace.
tags:
  - observability
  - tracing
  - python
  - api
  - regression
  - bug-582
timeout: 240

pre_run:
  - routine: global.start_observability

  - routine: global.setup_for_python_agent
    params:
      meshctl_version: "${config.packages.cli_version}"
      mcpmesh_version: "${config.packages.sdk_python_version}"

test:
  # Copy UC-level artifacts to workspace
  - name: "Copy artifacts to workspace"
    handler: shell
    command: |
      cp -rL /uc-artifacts/py-math-agent /workspace/
      cp -rL /uc-artifacts/py-mesh-api /workspace/
      echo "Artifacts copied"
      ls -la /workspace/
    capture: copy_output

  # Create env file with tracing enabled
  - name: "Create env file with secrets"
    handler: secrets
    source: /uc-artifacts/env.template
    target: /workspace/.env

  # Install Python dependencies for both agents
  - name: "Install py-math-agent dependencies"
    handler: pip-install
    path: /workspace/py-math-agent

  - name: "Install py-mesh-api dependencies"
    handler: pip-install
    path: /workspace/py-mesh-api

  # Start py-math-agent (tool provider)
  - name: "Start py-math-agent"
    handler: shell
    command: "meshctl start py-math-agent/main.py --env-file .env -d"
    workdir: /workspace
    capture: start_py_math

  # Start py-mesh-api (API route agent)
  - name: "Start py-mesh-api"
    handler: shell
    command: "meshctl start py-mesh-api/main.py --env-file .env -d"
    workdir: /workspace
    capture: start_api

  # Wait for both agents to register
  - name: "Wait for tool and API agents"
    handler: shell
    workdir: /workspace
    command: |
      echo "Waiting for py-math-agent and API agent (with deps resolved)..."
      for i in $(seq 1 20); do
        AGENTS=$(meshctl list 2>/dev/null || true)
        if echo "$AGENTS" | grep -q "py-math-agent" && echo "$AGENTS" | grep -q "API" && echo "$AGENTS" | grep "API" | grep -q "1/1"; then
          echo "Both agents registered and deps resolved after ${i} iterations"
          echo "$AGENTS"
          exit 0
        fi
        sleep 2
      done
      echo "ERROR: Agents did not register or deps not resolved within 40s"
      meshctl list 2>/dev/null || true
      exit 1
    capture: wait_agents
    timeout: 90

  # Verify agents are running
  - name: "List agents"
    handler: shell
    command: "meshctl list"
    workdir: /workspace
    capture: list_output

  # List tools to verify add is available
  - name: "List tools"
    handler: shell
    command: "meshctl list -t"
    workdir: /workspace
    capture: tools_output

  # Generate a trace ID so we can query it from Tempo later
  - name: "Generate trace ID"
    handler: shell
    workdir: /workspace
    command: |
      TRACE_ID=$(python3 -c "import secrets; print(secrets.token_hex(16))")
      echo "TRACE_ID=$TRACE_ID"
    capture: gen_trace_id

  # Call the API route with an explicit traceparent header
  # This ensures the trace ID is known and queryable from Tempo
  - name: "Call API route with traceparent header"
    handler: shell
    workdir: /workspace
    command: |
      TRACE_ID=$(echo "${captured.gen_trace_id}" | grep "TRACE_ID=" | cut -d= -f2)
      echo "Using trace ID: $TRACE_ID"
      RESPONSE=$(curl -s -X POST http://localhost:8080/api/add \
        -H 'Content-Type: application/json' \
        -H "traceparent: 00-${TRACE_ID}-0000000000000001-01" \
        -d '{"a": 10, "b": 20}')
      echo "API_RESPONSE=$RESPONSE"
    capture: api_call_output
    timeout: 30

  # Wait for spans to flush to Tempo
  - name: "Wait for trace flush"
    handler: wait
    seconds: 5

  # Query the trace from Tempo using the known trace ID
  - name: "Query trace from Tempo"
    handler: shell
    workdir: /workspace
    command: |
      TRACE_ID=$(echo "${captured.gen_trace_id}" | grep "TRACE_ID=" | cut -d= -f2)
      echo "Querying trace: $TRACE_ID"
      meshctl trace $TRACE_ID --json --retries 6 --retry-delay 5
    capture: trace_json
    timeout: 60

  # Check for route handler spans (from py-mesh-api / API agent)
  # Bug #582: This span is MISSING -- the route handler does not export spans
  - name: "Check for route handler spans"
    handler: shell
    workdir: /workspace
    command: |
      ROUTE_SPANS=$(echo '${captured.trace_json}' | jq '[.Spans[] | select(.AgentName | test("mesh.api|py-mesh-api|mesh-api"; "i"))] | length')
      echo "ROUTE_SPAN_COUNT=$ROUTE_SPANS"
    capture: route_span_check

  # Check for tool call spans (from py-math-agent)
  - name: "Check for tool call spans"
    handler: shell
    workdir: /workspace
    command: |
      TOOL_SPANS=$(echo '${captured.trace_json}' | jq '[.Spans[] | select(.AgentName | test("py-math-agent"; "i"))] | length')
      echo "TOOL_SPAN_COUNT=$TOOL_SPANS"
    capture: tool_span_check

  # Stop all agents
  - name: "Stop agents"
    handler: shell
    command: "meshctl stop"
    workdir: /workspace

assertions:
  # Agent registration
  - expr: "${captured.list_output} contains 'py-math-agent'"
    message: "py-math-agent should be registered"

  - expr: "${captured.list_output} contains 'API'"
    message: "API agent (py-mesh-api) should be registered with API type"

  # Tool availability
  - expr: "${captured.tools_output} contains 'add'"
    message: "add tool should be listed"

  # API call succeeded
  - expr: "${captured.api_call_output} contains 'result'"
    message: "API endpoint /api/add should return a result field"

  # Trace was captured
  - expr: "${captured.gen_trace_id} contains 'TRACE_ID='"
    message: "Trace ID should have been generated"

  - expr: ${jq:captured.trace_json:.SpanCount} >= 1
    message: "Trace should have at least 1 span"

  - expr: ${jq:captured.trace_json:.Success} == true
    message: "Trace query should succeed"

  # Tool span exists (this should pass -- tool spans work fine)
  - expr: "${captured.tool_span_check} contains 'TOOL_SPAN_COUNT='"
    message: "Tool span count should be extracted"

  - expr: "${captured.tool_span_check} not contains 'TOOL_SPAN_COUNT=0'"
    message: "Tool call span from py-math-agent should exist in trace"

  # Route handler span exists -- THIS SHOULD FAIL (bug #582)
  # The @mesh.route decorator does not export its handler span to Tempo.
  # When fixed, this assertion will pass.
  - expr: "${captured.route_span_check} not contains 'ROUTE_SPAN_COUNT=0'"
    message: "[Bug #582] Route handler span from py-mesh-api should exist in trace, but @mesh.route does not export spans"

  # Trace should involve both agents -- THIS SHOULD FAIL (bug #582)
  - expr: ${jq:captured.trace_json:.AgentCount} >= 2
    message: "[Bug #582] Trace should involve at least 2 agents (API route handler + tool provider)"

post_run:
  - handler: shell
    command: |
      pkill -f 'uvicorn' 2>/dev/null || true
      meshctl stop 2>/dev/null || true
    workdir: /workspace
    ignore_errors: true
  - routine: global.stop_observability
  - routine: global.cleanup_workspace
