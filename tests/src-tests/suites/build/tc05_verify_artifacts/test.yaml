# Test Case: Verify All Build Artifacts
# Ensures all packages are built and ready for use
#
# IMPORTANT: This test runs on the HOST (standalone mode)
# All artifacts should exist in ${run_path}/${config.output.base}

name: "Verify Build Artifacts"
description: "Verify all build artifacts are present and valid"
tags:
  - build
  - verify
timeout: 60

test:
  # Check meshctl binary
  - name: "Verify meshctl binary"
    handler: shell
    command: |
      echo "=== meshctl binary ==="
      ls -la "${run_path}/${config.output.bin}/meshctl"
      file "${run_path}/${config.output.bin}/meshctl"
    capture: meshctl_check

  # Check Python wheels
  - name: "Verify Python wheels"
    handler: shell
    command: |
      echo "=== Python wheels ==="
      ls -la "${run_path}/${config.output.wheels}"/*.whl
      echo ""
      echo "Wheel count: $(ls "${run_path}/${config.output.wheels}"/*.whl 2>/dev/null | wc -l)"
    capture: wheels_check

  # Check npm packages
  - name: "Verify npm packages"
    handler: shell
    command: |
      echo "=== npm packages ==="
      ls -la "${run_path}/${config.output.packages}"/*.tgz
      echo ""
      echo "Package count: $(ls "${run_path}/${config.output.packages}"/*.tgz 2>/dev/null | wc -l)"
    capture: packages_check

  # Check Java JARs (optional)
  - name: "Verify Java JARs"
    handler: shell
    command: |
      echo "=== Java JARs ==="
      if ls "${run_path}/${config.output.java_jars}"/*.jar 1> /dev/null 2>&1; then
        ls -la "${run_path}/${config.output.java_jars}"/*.jar
        echo ""
        echo "JAR count: $(ls "${run_path}/${config.output.java_jars}"/*.jar 2>/dev/null | wc -l)"
      else
        echo "No Java JARs found (optional)"
      fi
    capture: java_check
    ignore_errors: true

  # Check native libraries (optional)
  - name: "Verify native libraries"
    handler: shell
    command: |
      echo "=== Native libraries ==="
      if ls "${run_path}/${config.output.native_libs}"/libmcp_mesh_core.* 1> /dev/null 2>&1; then
        ls -la "${run_path}/${config.output.native_libs}"/libmcp_mesh_core.*
      else
        echo "No native libraries found (optional)"
      fi
    capture: native_check
    ignore_errors: true

  # Check Maven repository (optional)
  - name: "Verify Maven repository"
    handler: shell
    command: |
      echo "=== Maven repository ==="
      if [ -d "${run_path}/${config.output.m2_repo}/mcp-mesh" ]; then
        ls -la "${run_path}/${config.output.m2_repo}/mcp-mesh/"
      else
        echo "No Maven repository found (optional)"
      fi
    capture: m2_check
    ignore_errors: true

  # Summary
  - name: "Build summary"
    handler: shell
    command: |
      echo "=========================================="
      echo "BUILD ARTIFACTS SUMMARY"
      echo "=========================================="
      echo ""
      echo "Output directory: ${run_path}/${config.output.base}"
      echo ""
      echo "Binary:"
      if [ -f "${run_path}/${config.output.bin}/meshctl" ]; then
        echo "  [OK] meshctl"
      else
        echo "  [MISSING] meshctl"
      fi
      echo ""
      echo "Python wheels:"
      for whl in "${run_path}/${config.output.wheels}"/*.whl; do
        if [ -f "$whl" ]; then
          echo "  [OK] $(basename $whl)"
        fi
      done
      echo ""
      echo "npm packages:"
      for tgz in "${run_path}/${config.output.packages}"/*.tgz; do
        if [ -f "$tgz" ]; then
          echo "  [OK] $(basename $tgz)"
        fi
      done
      echo ""
      echo "Java JARs (optional):"
      if ls "${run_path}/${config.output.java_jars}"/*.jar 1> /dev/null 2>&1; then
        for jar in "${run_path}/${config.output.java_jars}"/*.jar; do
          if [ -f "$jar" ]; then
            echo "  [OK] $(basename $jar)"
          fi
        done
      else
        echo "  [SKIPPED] No Java JARs"
      fi
      echo ""
      echo "Native libraries (optional):"
      if ls "${run_path}/${config.output.native_libs}"/libmcp_mesh_core.* 1> /dev/null 2>&1; then
        for lib in "${run_path}/${config.output.native_libs}"/libmcp_mesh_core.*; do
          if [ -f "$lib" ]; then
            echo "  [OK] $(basename $lib)"
          fi
        done
      else
        echo "  [SKIPPED] No native libraries"
      fi
      echo ""
      echo "Maven repository (optional):"
      if [ -d "${run_path}/${config.output.m2_repo}/mcp-mesh" ]; then
        for mod in "${run_path}/${config.output.m2_repo}"/mcp-mesh/*/; do
          if [ -d "$mod" ]; then
            echo "  [OK] $(basename $mod)"
          fi
        done
      else
        echo "  [SKIPPED] No Maven repository"
      fi
      echo ""
      echo "=========================================="
      echo "All artifacts ready for image build"
      echo "=========================================="
    capture: summary

assertions:
  - expr: ${captured.meshctl_check} contains 'meshctl'
    message: "meshctl binary should exist"

  - expr: ${captured.wheels_check} contains '.whl'
    message: "Python wheels should exist"

  - expr: ${captured.packages_check} contains '.tgz'
    message: "npm packages should exist"

  - expr: ${captured.summary} contains 'All artifacts ready'
    message: "All artifacts should be ready"
